<!DOCTYPE html>
<html lang="en">
<head>
    <title><%- title %></title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
    <%
    // Add an og-image using the first image's thumbnail
    if (items?.[0]?.previewUrl) {
    %>
        <meta property="og:title" content="<%- title %>">
        <meta property="og:image" content="<%- publicBaseUrl %><%- items[0].previewUrl %>">
        <meta name="twitter:title" content="<%- title %>">
        <meta name="twitter:image" content="<%- publicBaseUrl %><%- items[0].previewUrl %>">
        <meta name="twitter:card" content="summary_large_image">
    <% } %>
    <link rel="icon" href="/share/static/favicon.ico" type="image/x-icon">
    <link type="text/css" rel="stylesheet" href="/share/static/style.css"/>
    <link type="text/css" rel="stylesheet" href="/share/static/lg/lightgallery-bundle.min.css"/>
</head>
<body>
<div id="header">
    <% if (showTitle) { %>
        <h1><%- title || 'Gallery' %></h1>
    <% } %>
    <%
    if (showDownload) {
    %>
        <div id="download-all">
            <button id="download-all-btn" title="Download all" style="background: none; border: none; cursor: pointer; padding: 0;">
                <img src="/share/static/images/download-all.svg" height="24" width="24" alt="Download all">
            </button>
        </div>
    <% } %>
</div>
<div id="lightgallery">
    <%
    // Load the first 50 thumbnails, then load more as the user scrolls. See web.js
    items.slice(0, 50).forEach(item => {
    %><%- item.html %>
    <% }) %>
</div>
<div id="loading-spinner"><span class="loader"></span></div>
<script src="/share/static/downloadModal.js"></script>
<script src="/share/static/web.js"></script>
<script src="/share/static/lg/lightgallery.min.js"></script>
<script src="/share/static/lg/lg-fullscreen.min.js"></script>
<script src="/share/static/lg/lg-thumbnail.min.js"></script>
<script src="/share/static/lg/lg-video.min.js"></script>
<script src="/share/static/lg/lg-zoom.min.js"></script>
<script type="text/javascript">
  // Expose RAW detection data to JavaScript
  window.rawAssets = <%- JSON.stringify(rawDetectionData) %>

  lgallery.init(<%- JSON.stringify({
      lgConfig,
      items,
      openItem
  }) %>) // initLightGallery imported from web.js
  <% if (openItem) { %>
  const openItem = <%- openItem %>
  const thumbs = document.querySelectorAll('#lightgallery a')
  if (thumbs.length >= openItem) {
    thumbs[openItem - 1].click()
  }
  <% } %>

  // Bulk download handler
  <% if (showDownload) { %>
  document.getElementById('download-all-btn')?.addEventListener('click', async () => {
    try {
      // Fetch download info
      const infoRes = await fetch('<%- path %>/download-info')
      const info = await infoRes.json()

      if (info.hasRaw) {
        // Show modal
        const modal = new DownloadModal()
        const choice = await modal.show({
          isIndividual: false,
          hasRawFiles: info.hasRaw,
          hasJpegFiles: info.hasNonRaw
        })

        if (choice && choice !== 'cancel') {
          window.location.href = '<%- path %>/download?filter=' + choice
        }
      } else {
        // No RAW files, proceed with normal download
        window.location.href = '<%- path %>/download'
      }
    } catch (error) {
      console.error('Download error:', error)
      // Fallback to direct download
      window.location.href = '<%- path %>/download'
    }
  })
  <% } %>
</script>
</body>
</html>
